// ======================================== 
// 应用状态管理
// ======================================== 

// 全局状态
const appState = {
    currentUser: '华仔',
    currentPage: 'home',
    isShuttingDown: false,
    shutdownTimer: null,
    inactivityTimer: null,
    users: {
        '华仔': {
            avatar: '华',
            color: '#2563EB',
            weight: 75.5,
            bmi: 22.3,
            fatPercentage: 16.2,
            muscleWeight: 48.6,
            waterPercentage: 58.8,
            boneWeight: 2.9,
            history: [
                { date: '2025-09-19', time: '14:30', weight: 75.5, fat: 16.2, muscle: 48.6, bmi: 22.3, water: 58.8, bone: 2.9 },
                { date: '2025-09-17', time: '08:45', weight: 75.3, fat: 16.0, muscle: 48.0, bmi: 22.2, water: 58.3, bone: 2.8 },
                { date: '2025-09-15', time: '14:15', weight: 74.8, fat: 15.5, muscle: 48.5, bmi: 22.0, water: 58.7, bone: 2.9 }
            ]
        },
        '亦菲': {
            avatar: '亦',
            color: '#DB2777',
            weight: 50.0,
            bmi: 19.8,
            fatPercentage: 22.5,
            muscleWeight: 36.1,
            waterPercentage: 55.2,
            boneWeight: 2.1,
            history: [
                { date: '2025-09-19', time: '14:32', weight: 50.0, fat: 22.5, muscle: 36.1, bmi: 19.8, water: 55.2, bone: 2.1 },
                { date: '2025-09-16', time: '08:50', weight: 49.8, fat: 22.3, muscle: 36.2, bmi: 19.7, water: 55.4, bone: 2.1 }
            ]
        },
        '志玲': {
            avatar: '志',
            color: '#059669',
            weight: 45.0,
            bmi: 18.5,
            fatPercentage: 20.8,
            muscleWeight: 32.4,
            waterPercentage: 56.8,
            boneWeight: 1.9,
            history: [
                { date: '2025-09-18', time: '09:15', weight: 45.0, fat: 20.8, muscle: 32.4, bmi: 18.5, water: 56.8, bone: 1.9 },
                { date: '2025-09-15', time: '19:20', weight: 45.2, fat: 21.0, muscle: 32.2, bmi: 18.6, water: 56.6, bone: 1.9 }
            ]
        },
        '访客': {
            avatar: 'G',
            color: '#616161',
            weight: 65.0, // 设置一个默认体重
            bmi: 0,
            fatPercentage: 0,
            muscleWeight: 0,
            waterPercentage: 0,
            boneWeight: 0,
            history: []
        }
    },
    settings: {
        unit: 'kg',
        autoShutdown: 0, // 禁用自动关机
        brightness: 80,
        sound: true,
        height: 175
    }
};

const INACTIVITY_TIMEOUT = 0; // 禁用自动关机

// ======================================== 
// 用户管理
// ======================================== 

function selectUser(userName) {
    appState.currentUser = userName;
    updateUserInterface();
    
    // 更新用户头像状态
    const avatars = document.querySelectorAll('.user-avatar');
    avatars.forEach(avatar => {
        avatar.classList.remove('active');
        if (avatar.dataset.user === userName) {
            avatar.classList.add('active');
        }
    });
    
    // 重置自动关机计时器
    resetShutdownTimer();
}

function updateUserInterface() {
    const userData = appState.users[appState.currentUser];
    if (!userData) return;
    
    // 更新主界面数据
    const elements = {
        'main-weight': userData.weight,
        'bmi-value': userData.bmi,
        'fat-percentage': userData.fatPercentage + '%',
        'muscle-mass': userData.muscleWeight + 'kg',
        'water-percentage': userData.waterPercentage + '%',
        'bone-mass': userData.boneWeight + 'kg',
        'bmr-value': calculateBMR(userData) + 'kcal'
    };
    
    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
        }
    });
    
    // 更新测量日期（如果有历史记录）
    const dateElement = document.getElementById('main-date');
    if (dateElement && userData.history && userData.history.length > 0) {
        const lastRecord = userData.history[userData.history.length - 1];
        dateElement.textContent = `${lastRecord.date} ${lastRecord.time}`;
    }
}

// ... (The rest of the file is restored to its original state before the data manager was introduced)

// ======================================== 
// 初始化
// ======================================== 

function initializeMain() {
    // 更新时间
    updateTime();
    setInterval(updateTime, 60000); // 每分钟更新一次
    
    // 更新用户界面
    updateUserInterface();
    
    // 设置导航事件监听
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.addEventListener('click', () => {
            const navType = item.dataset.nav;
            if (navType === 'start-measurement') {
                navigateToPage('measure');
            } else {
                navigateToPage(navType);
            }
        });
    });
    
    // 设置用户头像点击事件
    const userAvatars = document.querySelectorAll('.user-avatar');
    userAvatars.forEach(avatar => {
        avatar.addEventListener('click', () => {
            const userName = avatar.dataset.user;
            selectUser(userName);
        });
    });
    
    // 启动自动关机计时器
    resetShutdownTimer();
    
    // 添加用户活动监听（手势操作支持）
    ['click', 'touchstart', 'mousedown', 'mousemove', 'keydown'].forEach(eventType => {
        document.addEventListener(eventType, resetShutdownTimer);
    });
}

// ... (The rest of the original functions)

document.addEventListener('DOMContentLoaded', initializeMain);

// ======================================== 
// 添加用户功能
// ======================================== 

const availableAvatars = [
    { avatar: '爸', color: '#004D40' }, { avatar: '妈', color: '#4A148C' },
    { avatar: '哥', color: '#01579B' }, { avatar: '姐', color: '#880E4F' },
    { avatar: '爷', color: '#3E2723' }, { avatar: '奶', color: '#F57F17' },
    { avatar: 'A', color: '#1A237E' }, { avatar: 'B', color: '#BF360C' },
];

let selectedAvatar = null;

function showAddUserPage() {
    navigateToPage('add-user');
    prepareAddUserPage();
}

function prepareAddUserPage() {
    const nicknameInput = document.getElementById('nickname-input');
    const avatarPicker = document.getElementById('avatar-picker');
    const saveButton = document.getElementById('save-user-button');
    
    if (nicknameInput) nicknameInput.value = '';
    selectedAvatar = null;
    if (saveButton) saveButton.disabled = true;
    
    if (avatarPicker) {
        avatarPicker.innerHTML = '';
        availableAvatars.forEach(avatarInfo => {
            const avatarEl = document.createElement('div');
            avatarEl.className = 'avatar-option';
            avatarEl.style.backgroundColor = avatarInfo.color;
            avatarEl.textContent = avatarInfo.avatar;
            avatarEl.addEventListener('click', () => {
                document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
                avatarEl.classList.add('selected');
                selectedAvatar = avatarInfo;
                validateAddUserForm();
            });
            avatarPicker.appendChild(avatarEl);
        });
    }
}

function validateAddUserForm() {
    const nicknameInput = document.getElementById('nickname-input');
    const saveButton = document.getElementById('save-user-button');
    const isValid = nicknameInput && nicknameInput.value.trim() && selectedAvatar;
    if (saveButton) saveButton.disabled = !isValid;
}

function saveNewUser() {
    const nicknameInput = document.getElementById('nickname-input');
    const nickname = nicknameInput.value.trim();
    
    if (nickname && selectedAvatar) {
        // 添加新用户到状态
        appState.users[nickname] = {
            avatar: selectedAvatar.avatar,
            color: selectedAvatar.color,
            weight: 0,
            bmi: 0,
            fatPercentage: 0,
            muscleWeight: 0,
            waterPercentage: 0,
            boneWeight: 0,
            history: []
        };
        
        // 切换到新用户
        selectUser(nickname);
        
        // 返回主页
        navigateToPage('home');
        
        // 重新渲染用户列表
        location.reload(); // 简单的重新加载页面来更新用户列表
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', () => {
    initializeMain();
    
    // 添加用户表单事件监听
    const nicknameInput = document.getElementById('nickname-input');
    const saveButton = document.getElementById('save-user-button');
    
    if (nicknameInput) {
        nicknameInput.addEventListener('input', validateAddUserForm);
    }
    
    if (saveButton) {
        saveButton.addEventListener('click', saveNewUser);
    }
});

// ======================================== 
// 开发状态提示功能
// ======================================== 

/**
 * 显示开发中提示
 */
function showDevelopmentNotice(featureName) {
    // 创建提示元素
    const notice = document.createElement('div');
    notice.className = 'development-notice';
    notice.innerHTML = `
        <div class="development-notice-content">
            <div class="development-notice-icon">🚧</div>
            <div class="development-notice-title">${featureName}正在开发中</div>
            <div class="development-notice-message">该功能正在紧急开发中，敬请期待！</div>
        </div>
    `;
    
    // 添加样式
    notice.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease-out;
    `;
    
    // 内容样式
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .development-notice-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            max-width: 320px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        .development-notice-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .development-notice-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }
        .development-notice-message {
            font-size: 14px;
            color: #64748b;
            line-height: 1.5;
        }
    `;
    
    document.head.appendChild(style);
    document.body.appendChild(notice);
    
    // 3秒后自动关闭
    setTimeout(() => {
        notice.style.animation = 'fadeIn 0.3s ease-out reverse';
        setTimeout(() => {
            if (notice.parentNode) {
                notice.parentNode.removeChild(notice);
            }
            if (style.parentNode) {
                style.parentNode.removeChild(style);
            }
        }, 300);
    }, 3000);
    
    // 点击背景关闭
    notice.addEventListener('click', (e) => {
        if (e.target === notice) {
            notice.style.animation = 'fadeIn 0.3s ease-out reverse';
            setTimeout(() => {
                if (notice.parentNode) {
                    notice.parentNode.removeChild(notice);
                }
                if (style.parentNode) {
                    style.parentNode.removeChild(style);
                }
            }, 300);
        }
    });
}

// ======================================== 
// 导航功能
// ======================================== 

function openSettings() {
    window.location.href = 'settings.html';
}

function startMeasurement() {
    window.location.href = 'Preparation.html';
}

function viewMoreData() {
    window.location.href = 'detail.html';
}

function goToIndex() {
    window.location.href = 'index.html';
}

function goBack() {
    window.history.back();
}

function navigateToPage(page) {
    switch(page) {
        case 'home':
            window.location.href = 'main.html';
            break;
        case 'measure':
            window.location.href = 'Preparation.html';
            break;
        case 'history':
            window.location.href = 'history.html';
            break;
        case 'settings':
            window.location.href = 'settings.html';
            break;
        default:
            console.log('Unknown page:', page);
    }
}

// ======================================== 
// 工具函数
// ======================================== 

function updateTime() {
    const now = new Date();
    const timeString = now.toTimeString().slice(0, 5);
    const timeElements = document.querySelectorAll('.time');
    timeElements.forEach(element => {
        element.textContent = timeString;
    });
}

function calculateBMR(userData) {
    // 简化的BMR计算（Mifflin-St Jeor方程）
    // 假设用户为30岁男性，身高175cm
    const weight = parseFloat(userData.weight) || 70;
    const height = appState.settings.height || 175;
    const age = 30;
    
    // 男性 BMR = 10 × 体重(kg) + 6.25 × 身高(cm) - 5 × 年龄 + 5
    return Math.round(10 * weight + 6.25 * height - 5 * age + 5);
}
