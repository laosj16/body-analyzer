// ======================================== 
// åº”ç”¨çŠ¶æ€ç®¡ç†
// ======================================== 

// å…¨å±€çŠ¶æ€
const appState = {
    currentUser: 'åä»”',
    currentPage: 'home',
    isShuttingDown: false,
    shutdownTimer: null,
    inactivityTimer: null,
    users: {
        'åä»”': {
            avatar: 'å',
            color: '#2563EB',
            weight: 75.5,
            bmi: 22.3,
            fatPercentage: 16.2,
            muscleWeight: 48.6,
            waterPercentage: 58.8,
            boneWeight: 2.9,
            history: [
                { date: '2025-09-19', time: '14:30', weight: 75.5, fat: 16.2, muscle: 48.6, bmi: 22.3, water: 58.8, bone: 2.9 },
                { date: '2025-09-17', time: '08:45', weight: 75.3, fat: 16.0, muscle: 48.0, bmi: 22.2, water: 58.3, bone: 2.8 },
                { date: '2025-09-15', time: '14:15', weight: 74.8, fat: 15.5, muscle: 48.5, bmi: 22.0, water: 58.7, bone: 2.9 }
            ]
        },
        'äº¦è²': {
            avatar: 'äº¦',
            color: '#DB2777',
            weight: 50.0,
            bmi: 19.8,
            fatPercentage: 22.5,
            muscleWeight: 36.1,
            waterPercentage: 55.2,
            boneWeight: 2.1,
            history: [
                { date: '2025-09-19', time: '14:32', weight: 50.0, fat: 22.5, muscle: 36.1, bmi: 19.8, water: 55.2, bone: 2.1 },
                { date: '2025-09-16', time: '08:50', weight: 49.8, fat: 22.3, muscle: 36.2, bmi: 19.7, water: 55.4, bone: 2.1 }
            ]
        },
        'å¿—ç²': {
            avatar: 'å¿—',
            color: '#059669',
            weight: 45.0,
            bmi: 18.5,
            fatPercentage: 20.8,
            muscleWeight: 32.4,
            waterPercentage: 56.8,
            boneWeight: 1.9,
            history: [
                { date: '2025-09-18', time: '09:15', weight: 45.0, fat: 20.8, muscle: 32.4, bmi: 18.5, water: 56.8, bone: 1.9 },
                { date: '2025-09-15', time: '19:20', weight: 45.2, fat: 21.0, muscle: 32.2, bmi: 18.6, water: 56.6, bone: 1.9 }
            ]
        },
        'è®¿å®¢': {
            avatar: 'G',
            color: '#616161',
            weight: 65.0, // è®¾ç½®ä¸€ä¸ªé»˜è®¤ä½“é‡
            bmi: 0,
            fatPercentage: 0,
            muscleWeight: 0,
            waterPercentage: 0,
            boneWeight: 0,
            history: []
        }
    },
    settings: {
        unit: 'kg',
        autoShutdown: 0, // ç¦ç”¨è‡ªåŠ¨å…³æœº
        brightness: 80,
        sound: true,
        height: 175
    }
};

const INACTIVITY_TIMEOUT = 0; // ç¦ç”¨è‡ªåŠ¨å…³æœº

// ======================================== 
// ç”¨æˆ·ç®¡ç†
// ======================================== 

function selectUser(userName) {
    appState.currentUser = userName;
    updateUserInterface();
    
    // æ›´æ–°ç”¨æˆ·å¤´åƒçŠ¶æ€
    const avatars = document.querySelectorAll('.user-avatar');
    avatars.forEach(avatar => {
        avatar.classList.remove('active');
        if (avatar.dataset.user === userName) {
            avatar.classList.add('active');
        }
    });
    
    // é‡ç½®è‡ªåŠ¨å…³æœºè®¡æ—¶å™¨
    resetShutdownTimer();
}

function updateUserInterface() {
    const userData = appState.users[appState.currentUser];
    if (!userData) return;
    
    // æ›´æ–°ä¸»ç•Œé¢æ•°æ®
    const elements = {
        'main-weight': userData.weight,
        'bmi-value': userData.bmi,
        'fat-percentage': userData.fatPercentage + '%',
        'muscle-mass': userData.muscleWeight + 'kg',
        'water-percentage': userData.waterPercentage + '%',
        'bone-mass': userData.boneWeight + 'kg',
        'bmr-value': calculateBMR(userData) + 'kcal'
    };
    
    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
        }
    });
    
    // æ›´æ–°æµ‹é‡æ—¥æœŸï¼ˆå¦‚æœæœ‰å†å²è®°å½•ï¼‰
    const dateElement = document.getElementById('main-date');
    if (dateElement && userData.history && userData.history.length > 0) {
        const lastRecord = userData.history[userData.history.length - 1];
        dateElement.textContent = `${lastRecord.date} ${lastRecord.time}`;
    }
}

// ... (The rest of the file is restored to its original state before the data manager was introduced)

// ======================================== 
// åˆå§‹åŒ–
// ======================================== 

function initializeMain() {
    // æ›´æ–°æ—¶é—´
    updateTime();
    setInterval(updateTime, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
    
    // æ›´æ–°ç”¨æˆ·ç•Œé¢
    updateUserInterface();
    
    // è®¾ç½®å¯¼èˆªäº‹ä»¶ç›‘å¬
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.addEventListener('click', () => {
            const navType = item.dataset.nav;
            if (navType === 'start-measurement') {
                navigateToPage('measure');
            } else {
                navigateToPage(navType);
            }
        });
    });
    
    // è®¾ç½®ç”¨æˆ·å¤´åƒç‚¹å‡»äº‹ä»¶
    const userAvatars = document.querySelectorAll('.user-avatar');
    userAvatars.forEach(avatar => {
        avatar.addEventListener('click', () => {
            const userName = avatar.dataset.user;
            selectUser(userName);
        });
    });
    
    // å¯åŠ¨è‡ªåŠ¨å…³æœºè®¡æ—¶å™¨
    resetShutdownTimer();
    
    // æ·»åŠ ç”¨æˆ·æ´»åŠ¨ç›‘å¬ï¼ˆæ‰‹åŠ¿æ“ä½œæ”¯æŒï¼‰
    ['click', 'touchstart', 'mousedown', 'mousemove', 'keydown'].forEach(eventType => {
        document.addEventListener(eventType, resetShutdownTimer);
    });
}

// ... (The rest of the original functions)

document.addEventListener('DOMContentLoaded', initializeMain);

// ======================================== 
// æ·»åŠ ç”¨æˆ·åŠŸèƒ½
// ======================================== 

const availableAvatars = [
    { avatar: 'çˆ¸', color: '#004D40' }, { avatar: 'å¦ˆ', color: '#4A148C' },
    { avatar: 'å“¥', color: '#01579B' }, { avatar: 'å§', color: '#880E4F' },
    { avatar: 'çˆ·', color: '#3E2723' }, { avatar: 'å¥¶', color: '#F57F17' },
    { avatar: 'A', color: '#1A237E' }, { avatar: 'B', color: '#BF360C' },
];

let selectedAvatar = null;

function showAddUserPage() {
    navigateToPage('add-user');
    prepareAddUserPage();
}

function prepareAddUserPage() {
    const nicknameInput = document.getElementById('nickname-input');
    const avatarPicker = document.getElementById('avatar-picker');
    const saveButton = document.getElementById('save-user-button');
    
    if (nicknameInput) nicknameInput.value = '';
    selectedAvatar = null;
    if (saveButton) saveButton.disabled = true;
    
    if (avatarPicker) {
        avatarPicker.innerHTML = '';
        availableAvatars.forEach(avatarInfo => {
            const avatarEl = document.createElement('div');
            avatarEl.className = 'avatar-option';
            avatarEl.style.backgroundColor = avatarInfo.color;
            avatarEl.textContent = avatarInfo.avatar;
            avatarEl.addEventListener('click', () => {
                document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
                avatarEl.classList.add('selected');
                selectedAvatar = avatarInfo;
                validateAddUserForm();
            });
            avatarPicker.appendChild(avatarEl);
        });
    }
}

function validateAddUserForm() {
    const nicknameInput = document.getElementById('nickname-input');
    const saveButton = document.getElementById('save-user-button');
    const isValid = nicknameInput && nicknameInput.value.trim() && selectedAvatar;
    if (saveButton) saveButton.disabled = !isValid;
}

function saveNewUser() {
    const nicknameInput = document.getElementById('nickname-input');
    const nickname = nicknameInput.value.trim();
    
    if (nickname && selectedAvatar) {
        // æ·»åŠ æ–°ç”¨æˆ·åˆ°çŠ¶æ€
        appState.users[nickname] = {
            avatar: selectedAvatar.avatar,
            color: selectedAvatar.color,
            weight: 0,
            bmi: 0,
            fatPercentage: 0,
            muscleWeight: 0,
            waterPercentage: 0,
            boneWeight: 0,
            history: []
        };
        
        // åˆ‡æ¢åˆ°æ–°ç”¨æˆ·
        selectUser(nickname);
        
        // è¿”å›ä¸»é¡µ
        navigateToPage('home');
        
        // é‡æ–°æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
        location.reload(); // ç®€å•çš„é‡æ–°åŠ è½½é¡µé¢æ¥æ›´æ–°ç”¨æˆ·åˆ—è¡¨
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    initializeMain();
    
    // æ·»åŠ ç”¨æˆ·è¡¨å•äº‹ä»¶ç›‘å¬
    const nicknameInput = document.getElementById('nickname-input');
    const saveButton = document.getElementById('save-user-button');
    
    if (nicknameInput) {
        nicknameInput.addEventListener('input', validateAddUserForm);
    }
    
    if (saveButton) {
        saveButton.addEventListener('click', saveNewUser);
    }
});

// ======================================== 
// å¼€å‘çŠ¶æ€æç¤ºåŠŸèƒ½
// ======================================== 

/**
 * æ˜¾ç¤ºå¼€å‘ä¸­æç¤º
 */
function showDevelopmentNotice(featureName) {
    // åˆ›å»ºæç¤ºå…ƒç´ 
    const notice = document.createElement('div');
    notice.className = 'development-notice';
    notice.innerHTML = `
        <div class="development-notice-content">
            <div class="development-notice-icon">ğŸš§</div>
            <div class="development-notice-title">${featureName}æ­£åœ¨å¼€å‘ä¸­</div>
            <div class="development-notice-message">è¯¥åŠŸèƒ½æ­£åœ¨ç´§æ€¥å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼</div>
        </div>
    `;
    
    // æ·»åŠ æ ·å¼
    notice.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease-out;
    `;
    
    // å†…å®¹æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .development-notice-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            max-width: 320px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        .development-notice-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .development-notice-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }
        .development-notice-message {
            font-size: 14px;
            color: #64748b;
            line-height: 1.5;
        }
    `;
    
    document.head.appendChild(style);
    document.body.appendChild(notice);
    
    // 3ç§’åè‡ªåŠ¨å…³é—­
    setTimeout(() => {
        notice.style.animation = 'fadeIn 0.3s ease-out reverse';
        setTimeout(() => {
            if (notice.parentNode) {
                notice.parentNode.removeChild(notice);
            }
            if (style.parentNode) {
                style.parentNode.removeChild(style);
            }
        }, 300);
    }, 3000);
    
    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    notice.addEventListener('click', (e) => {
        if (e.target === notice) {
            notice.style.animation = 'fadeIn 0.3s ease-out reverse';
            setTimeout(() => {
                if (notice.parentNode) {
                    notice.parentNode.removeChild(notice);
                }
                if (style.parentNode) {
                    style.parentNode.removeChild(style);
                }
            }, 300);
        }
    });
}

// ======================================== 
// å¯¼èˆªåŠŸèƒ½
// ======================================== 

function openSettings() {
    window.location.href = 'settings.html';
}

function startMeasurement() {
    window.location.href = 'Preparation.html';
}

function viewMoreData() {
    window.location.href = 'detail.html';
}

function goToIndex() {
    window.location.href = 'index.html';
}

function goBack() {
    window.history.back();
}

function navigateToPage(page) {
    switch(page) {
        case 'home':
            window.location.href = 'main.html';
            break;
        case 'measure':
            window.location.href = 'Preparation.html';
            break;
        case 'history':
            window.location.href = 'history.html';
            break;
        case 'settings':
            window.location.href = 'settings.html';
            break;
        default:
            console.log('Unknown page:', page);
    }
}

// ======================================== 
// å·¥å…·å‡½æ•°
// ======================================== 

function updateTime() {
    const now = new Date();
    const timeString = now.toTimeString().slice(0, 5);
    const timeElements = document.querySelectorAll('.time');
    timeElements.forEach(element => {
        element.textContent = timeString;
    });
}

function calculateBMR(userData) {
    // ç®€åŒ–çš„BMRè®¡ç®—ï¼ˆMifflin-St Jeoræ–¹ç¨‹ï¼‰
    // å‡è®¾ç”¨æˆ·ä¸º30å²ç”·æ€§ï¼Œèº«é«˜175cm
    const weight = parseFloat(userData.weight) || 70;
    const height = appState.settings.height || 175;
    const age = 30;
    
    // ç”·æ€§ BMR = 10 Ã— ä½“é‡(kg) + 6.25 Ã— èº«é«˜(cm) - 5 Ã— å¹´é¾„ + 5
    return Math.round(10 * weight + 6.25 * height - 5 * age + 5);
}
